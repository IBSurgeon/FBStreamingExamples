# Служба (демон) fb_streaming_svc

Служба (демон) `fb_streaming_svc` предназначена для асинхронной обработки событий репликации.
Она отслеживает новые файлы журнала репликации в указанном каталоге, анализирует их, и генерирует события, которые обрабатываются одним из плагинов. 

Для конфигурации службы используется файл `fb_streaming.conf`, который должен быть расположен в той же директории, что и исполняемый файл `fb_streaming_svc`. 

Один экземпляр службы может обслуживать сразу несколько задач. Каждая задача работает в своём потоке. На каждый каталог с файлами журнала репликации создаётся своя задача. 

Задачи конфигурируются следующим образом:

```
logLevel = info

task = <archiveDir_1>
{
# другие параметры задачи 1
}

task = <archiveDir_2>
{
# другие параметры задачи 2
}
```

Здесь `archiveDir_N` - директория с файлами архивов журнала репликации. Эти директории должны быть уникальны. Одну и ту же директорию нельзя обрабатывать более чем одной задачей.

`logLevel` - уровень логирования (по умолчанию info). Допускаются уровни логирования: trace, debug, info, warning, error, critical, off. 

Основные параметры задачи:

- `lockDir` - директория в которой будет создан файл блокировок (по умолчанию та же директория, что и `archiveDir`);
- `database` - строка подключения к базе данных (обязательный);
- `username` - имя пользователя для подключения к базе данных;
- `password` - пароль для подключения к базе данных;
- `plugin` - плагин, который обрабатывает события, возникающие в процессе анализа журнала репликации (обязательный);
- `deleteProcessedFile` - удалять ли файл журнала после обработки (по умолчанию true). 

Задача может содержать также другие параметры, специфичные для используемого плагина.

Плагины для обработки событий из журнала репликации расположены в динамических библиотеках.
Имя файла динамической библиотеки зависит от операционной системы и строится следующим образом:

- для Windows `<имя плагина>.dll`
- для Linux `lib<имя плагина>.so`

Файл динамической библиотеки должен быть расположен в той же директории, что исполняемый файл `fb_streaming_svc`.

Для получения справки по использованию и установке службы наберите

```
fb_streaming_svc help
```

Вам будет выведена информация по установке, удаления, старту и остановки службы:

```
================================================================================
 Firebird streaming service

 Copyright (c) 2022 IBSurgeon ltd.
================================================================================

usage: fb_streaming_svc <command> [service_name]
Possible commands are:
    install            install service
    remove             remove service
    start              start service
    stop               stop service
```

После настройки файла конфигурации, вы можете установить и запустить службу, выполнив следующие команды:

```
c:\streaming>fb_streaming_svc install
Success install service!

c:\streaming>fb_streaming_svc start
Service start pending...
Service started successfully.
```

После установки вы можете управлять службой через графическую утилиту - службы (`services.msc`).

Для удаления службы выполните следующие команды:

```
c:\streaming>fb_streaming_svc stop
Service is already stopped.

c:\streaming>fb_streaming_svc remove
Service deleted successfully
```

Замечание. Если у вас будут функционировать несколько служб `fb_streaming_svc`, то при установке, запуске, остановке и удалении им надо дать уникальные имена.

Обратите внимание: папка с архивами журналов репликации должна обрабатываться только одной задачей службы `fb_streaming_svc`.
Если вы хотите чтобы, одновременно работала логическая репликация или с архивом журналов работало несколько служб, то необходимо дублирование архивных журналов в разные директории.

Это можно сделать в файле `replication.conf` следующим образом

```
...
journal_archive_directory = <archiveDir>
journal_archive_command = "copy $(pathname) $(archivepathname) && copy $(pathname) <archiveDirTask>
...
```

Здесь `archiveDir` - директория архивов для работы асинхронной репликации, `archiveDirTask` - директория архивов для работы задачи службы `fb_streaming_svc`.


## Принцип работы

Служба (демон) `fb_streaming_svc` проверяет содержимое директории, указанной для задачи в конфигурационном файле `fb_streaming.conf`, и если в этой директории присутствует ещё не обработанные файлы журнала репликации, то она анализирует их, и генерирует соответствующие события, которые обрабатываются указанным плагином. Последний номер обработанного сегмента репликации записывается в специальный файл `<database guid>.lock`. 
Расположение этого файла можно указать в параметре конфигурации `lockDir`. Если этот параметр не указан, то по умолчанию файл блокировок `<database guid>.lock` будет создан в директории, указанной в качестве директории для журналов архивов для задачи. Файл блокировок необходим, чтобы приложение не обрабатывало повторно уже обработанные журналы репликации.

Важно: файлы журналов репликации должны быть в архивном состоянии.

В процессе анализа журналов репликации могут возникать следующие события:

- старт транзакции (START);
- выполнение первой фазы подтверждения двухфазной транзакции (PREPARE);
- подтверждение транзакции (COMMIT);
- откат транзакции (ROLLBACK);
- установка точки сохранения (SAVE);
- откат точки сохранения (UNDO);
- освобождение точки сохранения (RELEASE);
- установка значения генератора (SET SEQUENCE);
- выполнение SQL оператора (EXECUTE SQL). Такие события происходят только для DDL операторов;
- сохранение BLOB (BLOB);
- вставка новой записи в таблицу (INSERT);
- обновление записи в таблице (UPDATE);
- удаление записи из таблицы (DELETE).

Какие из них будут обработаны, а какие просто проигнорированы зависит от выбранного плагина.
